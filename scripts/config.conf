#!/bin/bash

#   ***************************************************************************
#     config.conf.sh - configuration for android QGIS
#      --------------------------------------
#      Date                 : 01-Jun-2011
#      Copyright            : (C) 2011 by Marco Bernasocchi
#      Email                : marco at bernawebdesign.ch
#   ***************************************************************************
#   *                                                                         *
#   *   This program is free software; you can redistribute it and/or modify  *
#   *   it under the terms of the GNU General Public License as published by  *
#   *   the Free Software Foundation; either version 2 of the License, or     *
#   *   (at your option) any later version.                                   *
#   *                                                                         *
#   ***************************************************************************/


set -e
#######check if config was already loaded#######
if [ ! -n "${QGIS_ANDROID_CONF_LOADED+x}" ]; then
	#############################
	#######CONFIGURE HERE########
	#############################
	export NECESSITAS_DIR=$HOME/dev/necessitas
	export ROOT_DIR=$HOME/dev/qgis-android
	export ANDROID_TARGET_ARCH=armeabi-v7a
	export QGIS_DIR=$HOME/dev/qgis
	
	######LIKELY UNNEEDED TO CONFIGURE FURTHER######
	export QGIS_BUILD_DIR=$QGIS_DIR/build
	export INSTALL_DIR=$ROOT_DIR/out/$ANDROID_TARGET_ARCH
	export SCRIPT_DIR=$ROOT_DIR/scripts
	export PATCH_DIR=$ROOT_DIR/patches
	export SRC_DIR=$ROOT_DIR/src
	export TMP_DIR=$ROOT_DIR/tmp
	export ANDROID_LEVEL=9
	export ANDROID_SDK_ROOT=$NECESSITAS_DIR/android-sdk-linux_x86
	export ANDROID_NDK_ROOT=$NECESSITAS_DIR/android-ndk-r5c
	export ANDROID_NDK_PLATFORM=android-$ANDROID_LEVEL
	export ANDROID_NDK_HOST=linux-x86
	export ANDROID_NDK_TOOLCHAIN_PREFIX=arm-linux-androideabi
	export ANDROID_NDK_TOOLCHAIN_VERSION=4.4.3
	export ANDROID_NDK_TOOLCHAIN_ROOT=$NECESSITAS_DIR/$ANDROID_NDK_PLATFORM-standalonetoolchain
	export QT_ROOT=$NECESSITAS_DIR/Android/Qt/4762/$ANDROID_TARGET_ARCH
	export QT_SRC=$NECESSITAS_DIR/Android/Qt/4762/qt-src
	export QT_INCLUDE=$QT_ROOT/include
	export QMAKE=$QT_ROOT/bin/qmake
	export QTAPK_DIR=$ROOT_DIR/QtApk
	export APK_DIR=$QTAPK_DIR/android
	
	#setting compilers names
	#see https://groups.google.com/forum/?hl=en#!topic/android-ndk/DVNS_mQHxdA
	export PATH=$ANDROID_NDK_TOOLCHAIN_ROOT/bin:$ANDROID_SDK_ROOT/tools:$ANDROID_SDK_ROOT/platform-tools:$PATH
	export CC=arm-linux-androideabi-gcc
    export CXX=arm-linux-androideabi-g++
    export LD=arm-linux-androideabi-ld
    export AR=arm-linux-androideabi-ar
    export RANLIB=arm-linux-androideabi-ranlib
    export AS=arm-linux-androideabi-as

	export MY_STD_CONFIGURE_FLAGS=--prefix=$INSTALL_DIR --host=arm-linux-androideabi
  #FPU (floating point unit)FLAG:
  #see http://gcc.gnu.org/onlinedocs/gcc-4.4.3/gcc/ARM-Options.html
  #see http://infocenter.arm.com/help/index.jsp?topic=/com.arm.doc.ddi0408f/index.html
  #see NDK docs/STANDALONE-TOOLCHAIN.html
  #for tegra processors (xoom, transformer, iconia, galaxy tab)
  #MY_FPU=vfpv3-d16
  #for hummingbird and neon supporting processors (galaxy phone) -mfpu=neon
  #MY_FPU=neon
   export MY_FPU=vfp

  #TODO check flags
  #ALL_FLAGS="-c -Wno-psabi -mthumb -march=armv7-a -mfloat-abi=softfp -mfpu=vfp -fpic -ffunction-sections -funwind-tables -fstack-protector -fno-short-enums -DANDROID -D__ARM_ARCH_5__ -D__ARM_ARCH_5T__ -D__ARM_ARCH_5E__ -D__ARM_ARCH_5TE__ -Wa,--noexecstack -DQT_NO_QWS_TRANSFORMED -O2 -Os -g -fomit-frame-pointer -fno-strict-aliasing -finline-limit=64 -D_REENTRANT -Wall -Wno-psabi -W -fPIC -DQT_NO_DEBUG -DQT_GUI_LIB -DQT_CORE_LIB -DQT_SHARED -I/opt/necessitas/Android/Qt/4762/armeabi-v7a/mkspecs/default -I../../qwt-5.2.0/src -I/opt/necessitas/Android/Qt/4762/armeabi-v7a/include/QtCore -I/opt/necessitas/Android/Qt/4762/armeabi-v7a/include/QtGui -I/opt/necessitas/Android/Qt/4762/armeabi-v7a/include -Imoc -I. -I/opt/necessitas/android-ndk-r5c/platforms/android-8/arch-arm/usr/include -I/opt/necessitas/android-ndk-r5c/sources/cxx-stl/gnu-libstdc++/include -I/opt/necessitas/android-ndk-r5c/sources/cxx-stl/gnu-libstdc++/libs/armeabi/include -I."
  export MY_STD_CFLAGS="-DANDROID=ON -Wno-psabi -O2 -mthumb -march=armv7-a -mfloat-abi=softfp -mfpu=$MY_FPU"
  #needed the others?
  #export MY_STD_CFLAGS="$MY_STD_CFLAGS" #-D__ARM_ARCH_5__ -D__ARM_ARCH_5T__ -D__ARM_ARCH_5E__ -D__ARM_ARCH_5TE__ -D__ARM_ARCH_7-A__"
  export MY_STD_LDFLAGS="-Wl,--fix-cortex-a8"

	#############################
	#######END CONFIGURE#########
	#############################

	#######detect cpu cores######
	export CORES=$(cat /proc/cpuinfo | grep processor | wc -l)

	#######mark conf as loaded#######
	export QGIS_ANDROID_CONF_LOADED=1
fi
